"""
Vulnerability Map Visualization
시군구별 취약성 지도 시각화

Outputs:
- 취약성 지수 choropleth 지도
- 복합 이벤트 빈도 히트맵
- 시계열 트렌드 차트
"""

import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
import matplotlib.colors as mcolors
import matplotlib.patches as mpatches
from matplotlib.colors import LinearSegmentedColormap
import seaborn as sns
from pathlib import Path
from typing import Dict, List, Optional, Tuple
import json

# 한글 폰트 설정
plt.rcParams['font.family'] = 'Malgun Gothic'
plt.rcParams['axes.unicode_minus'] = False


class VulnerabilityMapVisualizer:
    """취약성 지도 시각화 클래스"""

    # 시도별 중심 좌표 (간이)
    PROVINCE_COORDS = {
        '서울': (37.5665, 126.9780),
        '부산': (35.1796, 129.0756),
        '대구': (35.8714, 128.6014),
        '인천': (37.4563, 126.7052),
        '광주': (35.1595, 126.8526),
        '대전': (36.3504, 127.3845),
        '울산': (35.5384, 129.3114),
        '세종': (36.4800, 127.2890),
        '경기': (37.4138, 127.5183),
        '강원': (37.8228, 128.1555),
        '충북': (36.6357, 127.4917),
        '충남': (36.5184, 126.8000),
        '전북': (35.8203, 127.1088),
        '전남': (34.8161, 126.4629),
        '경북': (36.4919, 128.8889),
        '경남': (35.4606, 128.2132),
        '제주': (33.4996, 126.5312),
    }

    # 취약성 색상 매핑
    VULNERABILITY_CMAP = LinearSegmentedColormap.from_list(
        'vulnerability',
        ['#2ecc71', '#f1c40f', '#e67e22', '#e74c3c', '#8e44ad']  # 녹색→노랑→주황→빨강→보라
    )

    def __init__(self, output_dir: str = "results/figures"):
        self.output_dir = Path(output_dir)
        self.output_dir.mkdir(parents=True, exist_ok=True)

    def plot_vulnerability_map(
        self,
        vulnerability_scores: Dict[str, float],
        title: str = "Compound Climate Event Vulnerability Index",
        figsize: Tuple[int, int] = (12, 10)
    ) -> plt.Figure:
        """
        취약성 지수 지도 시각화

        Args:
            vulnerability_scores: {지역명: 취약성 점수}
            title: 그래프 제목
            figsize: 그림 크기
        """
        fig, ax = plt.subplots(figsize=figsize)

        # 배경색
        ax.set_facecolor('#f5f5f5')

        # 각 지역 표시
        for region, score in vulnerability_scores.items():
            # 시도 매칭
            province = None
            for prov in self.PROVINCE_COORDS.keys():
                if prov in region:
                    province = prov
                    break

            if province:
                lat, lon = self.PROVINCE_COORDS[province]

                # 취약성에 따른 색상
                color = self.VULNERABILITY_CMAP(score)

                # 원으로 표시 (크기는 점수에 비례)
                circle_size = 300 + score * 500
                ax.scatter(lon, lat, s=circle_size, c=[color],
                          edgecolors='white', linewidths=2, alpha=0.8)

                # 지역명과 점수 표시
                ax.annotate(
                    f"{region}\n{score:.2f}",
                    (lon, lat),
                    ha='center', va='center',
                    fontsize=8, fontweight='bold',
                    color='white' if score > 0.5 else 'black'
                )

        # 축 설정
        ax.set_xlim(124, 132)
        ax.set_ylim(33, 43)
        ax.set_xlabel('Longitude (°E)', fontsize=12)
        ax.set_ylabel('Latitude (°N)', fontsize=12)
        ax.set_title(title, fontsize=14, fontweight='bold', pad=20)

        # 컬러바
        sm = plt.cm.ScalarMappable(cmap=self.VULNERABILITY_CMAP, norm=plt.Normalize(0, 1))
        sm.set_array([])
        cbar = plt.colorbar(sm, ax=ax, shrink=0.7, label='Vulnerability Index')
        cbar.set_ticks([0, 0.25, 0.5, 0.75, 1.0])
        cbar.set_ticklabels(['Very Low', 'Low', 'Medium', 'High', 'Very High'])

        plt.tight_layout()
        return fig

    def plot_event_frequency_heatmap(
        self,
        event_data: pd.DataFrame,
        figsize: Tuple[int, int] = (14, 8)
    ) -> plt.Figure:
        """
        복합 이벤트 유형별 발생 빈도 히트맵

        Args:
            event_data: columns=['year', 'region', 'event_type', 'count']
        """
        fig, ax = plt.subplots(figsize=figsize)

        # 피벗 테이블 생성
        pivot = event_data.pivot_table(
            values='count',
            index='region',
            columns='event_type',
            aggfunc='sum',
            fill_value=0
        )

        # 히트맵
        sns.heatmap(
            pivot,
            ax=ax,
            cmap='YlOrRd',
            annot=True,
            fmt='.0f',
            linewidths=0.5,
            cbar_kws={'label': 'Event Count'}
        )

        ax.set_title('Compound Extreme Event Frequency by Region and Type', fontsize=14, pad=20)
        ax.set_xlabel('Event Type', fontsize=12)
        ax.set_ylabel('Region', fontsize=12)

        plt.tight_layout()
        return fig

    def plot_trend_analysis(
        self,
        annual_data: pd.DataFrame,
        figsize: Tuple[int, int] = (14, 10)
    ) -> plt.Figure:
        """
        연간 트렌드 분석 차트

        Args:
            annual_data: columns=['year', 'event_type', 'count', 'severity', 'damage']
        """
        fig, axes = plt.subplots(2, 2, figsize=figsize)

        # 1. 이벤트 빈도 트렌드
        ax1 = axes[0, 0]
        event_counts = annual_data.groupby('year')['count'].sum()
        ax1.plot(event_counts.index, event_counts.values, 'b-o', linewidth=2, markersize=6)
        ax1.fill_between(event_counts.index, event_counts.values, alpha=0.3)
        ax1.set_xlabel('Year')
        ax1.set_ylabel('Event Count')
        ax1.set_title('Annual Compound Event Frequency')
        ax1.grid(True, alpha=0.3)

        # 추세선
        z = np.polyfit(event_counts.index, event_counts.values, 1)
        p = np.poly1d(z)
        ax1.plot(event_counts.index, p(event_counts.index), 'r--',
                label=f'Trend (slope={z[0]:.2f}/year)')
        ax1.legend()

        # 2. 이벤트 유형별 비율
        ax2 = axes[0, 1]
        type_counts = annual_data.groupby('event_type')['count'].sum()
        colors = plt.cm.Set2(np.linspace(0, 1, len(type_counts)))
        wedges, texts, autotexts = ax2.pie(
            type_counts.values,
            labels=type_counts.index,
            autopct='%1.1f%%',
            colors=colors,
            explode=[0.05] * len(type_counts)
        )
        ax2.set_title('Event Type Distribution')

        # 3. 평균 강도 트렌드
        ax3 = axes[1, 0]
        severity_trend = annual_data.groupby('year')['severity'].mean()
        ax3.bar(severity_trend.index, severity_trend.values, color='coral', alpha=0.7)
        ax3.set_xlabel('Year')
        ax3.set_ylabel('Mean Severity')
        ax3.set_title('Annual Mean Event Severity')
        ax3.grid(True, alpha=0.3, axis='y')

        # 4. 피해액 트렌드
        ax4 = axes[1, 1]
        damage_trend = annual_data.groupby('year')['damage'].sum() / 1e6  # 백만원 단위
        ax4.bar(damage_trend.index, damage_trend.values, color='steelblue', alpha=0.7)
        ax4.set_xlabel('Year')
        ax4.set_ylabel('Total Damage (Million KRW)')
        ax4.set_title('Annual Total Damage from Compound Events')
        ax4.grid(True, alpha=0.3, axis='y')

        plt.tight_layout()
        return fig

    def plot_model_performance(
        self,
        metrics: Dict[str, Dict[str, float]],
        figsize: Tuple[int, int] = (12, 5)
    ) -> plt.Figure:
        """
        AI 모델 성능 비교 차트

        Args:
            metrics: {model_name: {metric_name: value}}
        """
        fig, axes = plt.subplots(1, 2, figsize=figsize)

        # 모델 이름과 메트릭 추출
        models = list(metrics.keys())
        metric_names = list(next(iter(metrics.values())).keys())

        # 1. 바 차트 비교
        ax1 = axes[0]
        x = np.arange(len(models))
        width = 0.25

        for i, metric in enumerate(metric_names[:3]):  # 최대 3개 메트릭
            values = [metrics[m].get(metric, 0) for m in models]
            ax1.bar(x + i * width, values, width, label=metric, alpha=0.8)

        ax1.set_xlabel('Model')
        ax1.set_ylabel('Score')
        ax1.set_title('Model Performance Comparison')
        ax1.set_xticks(x + width)
        ax1.set_xticklabels(models, rotation=45, ha='right')
        ax1.legend()
        ax1.grid(True, alpha=0.3, axis='y')

        # 2. 레이더 차트
        ax2 = axes[1]

        # 레이더 차트 설정
        angles = np.linspace(0, 2 * np.pi, len(metric_names), endpoint=False).tolist()
        angles += angles[:1]

        ax2 = fig.add_subplot(122, polar=True)

        for model in models[:3]:  # 최대 3개 모델
            values = [metrics[model].get(m, 0) for m in metric_names]
            values += values[:1]
            ax2.plot(angles, values, 'o-', linewidth=2, label=model)
            ax2.fill(angles, values, alpha=0.1)

        ax2.set_xticks(angles[:-1])
        ax2.set_xticklabels(metric_names)
        ax2.set_title('Model Performance Radar')
        ax2.legend(loc='upper right', bbox_to_anchor=(1.3, 1))

        plt.tight_layout()
        return fig

    def plot_architecture_diagram(
        self,
        figsize: Tuple[int, int] = (14, 8)
    ) -> plt.Figure:
        """AI 모델 아키텍처 다이어그램"""
        fig, ax = plt.subplots(figsize=figsize)
        ax.set_xlim(0, 14)
        ax.set_ylim(0, 8)
        ax.axis('off')

        # 색상 정의
        colors = {
            'input': '#3498db',
            'process': '#2ecc71',
            'model': '#e74c3c',
            'output': '#9b59b6'
        }

        # 박스 그리기 함수
        def draw_box(x, y, w, h, text, color, fontsize=10):
            rect = mpatches.FancyBboxPatch(
                (x, y), w, h,
                boxstyle="round,pad=0.05,rounding_size=0.2",
                facecolor=color, edgecolor='white', linewidth=2, alpha=0.8
            )
            ax.add_patch(rect)
            ax.text(x + w/2, y + h/2, text, ha='center', va='center',
                   fontsize=fontsize, fontweight='bold', color='white',
                   wrap=True)

        # 화살표 그리기 함수
        def draw_arrow(x1, y1, x2, y2):
            ax.annotate('', xy=(x2, y2), xytext=(x1, y1),
                       arrowprops=dict(arrowstyle='->', color='gray', lw=2))

        # 입력 데이터
        draw_box(0.5, 6, 2.5, 1.5, 'Climate Data\n(KMA, ERA5)', colors['input'])
        draw_box(0.5, 4, 2.5, 1.5, 'Socioeconomic\nData', colors['input'])
        draw_box(0.5, 2, 2.5, 1.5, 'Regional\nVulnerability', colors['input'])

        # 전처리
        draw_box(4, 4, 2.5, 3, 'Preprocessing\n\n• Extreme Detection\n• Compound ID\n• Feature Eng.', colors['process'])

        # AI 모델
        draw_box(7.5, 5.5, 3, 1.5, 'Transformer\nEvent Detector', colors['model'])
        draw_box(7.5, 3.5, 3, 1.5, 'GNN\nSpatial Analyzer', colors['model'])
        draw_box(7.5, 1.5, 3, 1.5, 'XGBoost+NN\nImpact Predictor', colors['model'])

        # 출력
        draw_box(11.5, 4, 2, 3, 'Outputs\n\n• Vulnerability\n  Index\n• Impact\n  Prediction\n• Risk Map', colors['output'])

        # 화살표
        draw_arrow(3, 6.75, 4, 6)
        draw_arrow(3, 4.75, 4, 5)
        draw_arrow(3, 2.75, 4, 4)
        draw_arrow(6.5, 5.5, 7.5, 6.25)
        draw_arrow(6.5, 5, 7.5, 4.25)
        draw_arrow(6.5, 4.5, 7.5, 2.25)
        draw_arrow(10.5, 6.25, 11.5, 6)
        draw_arrow(10.5, 4.25, 11.5, 5.5)
        draw_arrow(10.5, 2.25, 11.5, 4.5)

        ax.set_title('AI-Driven Compound Climate Event Analysis Framework',
                    fontsize=16, fontweight='bold', pad=20)

        return fig

    def save_figure(self, fig: plt.Figure, filename: str, dpi: int = 300):
        """그림 저장"""
        filepath = self.output_dir / filename
        fig.savefig(filepath, dpi=dpi, bbox_inches='tight', facecolor='white')
        print(f"Saved: {filepath}")
        plt.close(fig)


def generate_sample_data() -> Tuple[Dict, pd.DataFrame, pd.DataFrame]:
    """샘플 데이터 생성"""
    np.random.seed(42)

    # 취약성 점수
    regions = [
        '서울', '부산', '대구', '인천', '광주', '대전', '울산',
        '경기', '강원', '충북', '충남', '전북', '전남', '경북', '경남', '제주'
    ]
    vulnerability_scores = {r: np.random.uniform(0.2, 0.9) for r in regions}

    # 이벤트 데이터
    event_types = ['Heat+Drought', 'Heat+Tropical', 'Cold+Snow', 'Rain→Heat', 'Drought→Rain']
    event_data = []
    for year in range(2000, 2024):
        for region in regions:
            for etype in event_types:
                event_data.append({
                    'year': year,
                    'region': region,
                    'event_type': etype,
                    'count': np.random.poisson(2),
                    'severity': np.random.uniform(1, 5),
                    'damage': np.random.exponential(500)
                })
    event_df = pd.DataFrame(event_data)

    # 연간 데이터
    annual_data = event_df.groupby(['year', 'event_type']).agg({
        'count': 'sum',
        'severity': 'mean',
        'damage': 'sum'
    }).reset_index()

    return vulnerability_scores, event_df, annual_data


def main():
    """시각화 테스트"""
    print("Generating visualizations...")

    # 샘플 데이터 생성
    vulnerability_scores, event_df, annual_data = generate_sample_data()

    # 시각화기 생성
    visualizer = VulnerabilityMapVisualizer(output_dir="../../results/figures")

    # 1. 취약성 지도
    fig = visualizer.plot_vulnerability_map(vulnerability_scores)
    visualizer.save_figure(fig, "vulnerability_map.png")

    # 2. 이벤트 빈도 히트맵
    fig = visualizer.plot_event_frequency_heatmap(event_df)
    visualizer.save_figure(fig, "event_frequency_heatmap.png")

    # 3. 트렌드 분석
    fig = visualizer.plot_trend_analysis(annual_data)
    visualizer.save_figure(fig, "trend_analysis.png")

    # 4. 모델 성능
    metrics = {
        'Transformer': {'F1-Score': 0.85, 'Precision': 0.82, 'Recall': 0.88, 'AUC': 0.91},
        'GNN': {'F1-Score': 0.78, 'Precision': 0.80, 'Recall': 0.76, 'AUC': 0.84},
        'XGBoost': {'F1-Score': 0.82, 'Precision': 0.85, 'Recall': 0.79, 'AUC': 0.88},
        'Ensemble': {'F1-Score': 0.89, 'Precision': 0.87, 'Recall': 0.91, 'AUC': 0.94}
    }
    fig = visualizer.plot_model_performance(metrics)
    visualizer.save_figure(fig, "model_performance.png")

    # 5. 아키텍처 다이어그램
    fig = visualizer.plot_architecture_diagram()
    visualizer.save_figure(fig, "architecture_diagram.png")

    print("\nAll visualizations saved!")


if __name__ == "__main__":
    main()
