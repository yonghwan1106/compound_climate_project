"""
Precise Vulnerability Map Generator
한국 시군구 취약성 지도 정밀 시각화
"""

import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
import matplotlib.patches as mpatches
from matplotlib.colors import LinearSegmentedColormap, Normalize
from matplotlib.cm import ScalarMappable
from pathlib import Path
import warnings
warnings.filterwarnings('ignore')

# 한글 폰트 설정
plt.rcParams['font.family'] = 'Malgun Gothic'
plt.rcParams['axes.unicode_minus'] = False

# 취약성 데이터 로드
def load_vulnerability_data():
    """취약성 데이터 로드"""
    data = {
        'region': ['서울 강남구', '서울 강북구', '서울 종로구', '부산 해운대구', '부산 사하구',
                   '대구 수성구', '대구 달서구', '인천 남동구', '인천 강화군', '경기 수원시',
                   '경기 성남시', '경기 용인시', '경기 화성시', '강원 춘천시', '강원 강릉시',
                   '강원 원주시', '충북 청주시', '충북 충주시', '충남 천안시', '충남 아산시',
                   '전북 전주시', '전북 익산시', '전남 목포시', '전남 순천시', '경북 포항시',
                   '경북 경주시', '경남 창원시', '경남 김해시', '제주 제주시', '제주 서귀포시'],
        'exposure': [0.438, 0.419, 0.301, 0.540, 0.287, 0.522, 0.417, 0.655, 0.341, 0.571,
                     0.571, 0.329, 0.379, 0.545, 0.601, 0.508, 0.419, 0.506, 0.419, 0.400,
                     0.634, 0.589, 0.378, 0.425, 0.395, 0.302, 0.467, 0.761, 0.522, 0.264],
        'sensitivity': [0.461, 0.468, 0.486, 0.440, 0.506, 0.478, 0.517, 0.425, 0.493, 0.213,
                        0.285, 0.167, 0.291, 0.206, 0.215, 0.215, 0.111, 0.176, 0.220, 0.227,
                        0.240, 0.203, 0.205, 0.191, 0.213, 0.194, 0.186, 0.155, 0.235, 0.283],
        'adaptive_capacity': [0.315, 0.669, 0.578, 0.421, 0.361, 0.364, 0.627, 0.621, 0.289, 0.324,
                              0.344, 0.334, 0.584, 0.539, 0.471, 0.499, 0.405, 0.360, 0.617, 0.371,
                              0.624, 0.422, 0.652, 0.411, 0.615, 0.657, 0.607, 0.388, 0.652, 0.602],
        'vulnerability': [0.603, 0.349, 0.323, 0.548, 0.427, 0.636, 0.385, 0.461, 0.560, 0.407,
                          0.480, 0.268, 0.282, 0.294, 0.337, 0.301, 0.239, 0.319, 0.259, 0.318,
                          0.317, 0.343, 0.241, 0.288, 0.252, 0.226, 0.255, 0.356, 0.282, 0.245],
        'risk_level': ['High', 'Low', 'Low', 'Medium', 'Medium', 'High', 'Low', 'Medium', 'Medium', 'Medium',
                       'Medium', 'Low', 'Low', 'Low', 'Low', 'Low', 'Low', 'Low', 'Low', 'Low',
                       'Low', 'Low', 'Low', 'Low', 'Low', 'Low', 'Low', 'Low', 'Low', 'Low']
    }
    return pd.DataFrame(data)

# 시도별 위치 정보 (위도, 경도, 크기)
PROVINCE_INFO = {
    '서울': {'lat': 37.57, 'lon': 127.00, 'size': 1.0, 'polygon': 'small'},
    '부산': {'lat': 35.18, 'lon': 129.08, 'size': 0.8, 'polygon': 'small'},
    '대구': {'lat': 35.87, 'lon': 128.60, 'size': 0.8, 'polygon': 'small'},
    '인천': {'lat': 37.46, 'lon': 126.70, 'size': 0.9, 'polygon': 'medium'},
    '광주': {'lat': 35.16, 'lon': 126.85, 'size': 0.6, 'polygon': 'small'},
    '대전': {'lat': 36.35, 'lon': 127.38, 'size': 0.6, 'polygon': 'small'},
    '울산': {'lat': 35.54, 'lon': 129.31, 'size': 0.7, 'polygon': 'small'},
    '세종': {'lat': 36.48, 'lon': 127.29, 'size': 0.5, 'polygon': 'small'},
    '경기': {'lat': 37.41, 'lon': 127.52, 'size': 1.5, 'polygon': 'large'},
    '강원': {'lat': 37.82, 'lon': 128.16, 'size': 1.8, 'polygon': 'large'},
    '충북': {'lat': 36.64, 'lon': 127.49, 'size': 1.3, 'polygon': 'large'},
    '충남': {'lat': 36.52, 'lon': 126.80, 'size': 1.4, 'polygon': 'large'},
    '전북': {'lat': 35.82, 'lon': 127.11, 'size': 1.2, 'polygon': 'large'},
    '전남': {'lat': 34.82, 'lon': 126.46, 'size': 1.5, 'polygon': 'large'},
    '경북': {'lat': 36.49, 'lon': 128.89, 'size': 1.7, 'polygon': 'large'},
    '경남': {'lat': 35.46, 'lon': 128.21, 'size': 1.4, 'polygon': 'large'},
    '제주': {'lat': 33.50, 'lon': 126.53, 'size': 1.0, 'polygon': 'medium'},
}

def create_detailed_vulnerability_map(df, output_path):
    """상세 취약성 지도 생성 - Figure 3"""

    fig = plt.figure(figsize=(16, 14))

    # 메인 지도 영역
    ax_main = fig.add_axes([0.05, 0.25, 0.65, 0.65])

    # 색상 맵 설정
    cmap = LinearSegmentedColormap.from_list('vuln',
        ['#1a9850', '#91cf60', '#d9ef8b', '#fee08b', '#fc8d59', '#d73027'])
    norm = Normalize(vmin=0.2, vmax=0.7)

    # 배경
    ax_main.set_facecolor('#e8f4f8')

    # 한국 경계선 (간이)
    korea_lon = [126, 127, 128, 129, 130, 130, 129, 128, 127, 126, 125, 126]
    korea_lat = [34, 34, 35, 35.5, 36, 38, 39, 38.5, 38, 37.5, 36, 34]
    ax_main.plot(korea_lon, korea_lat, 'k-', linewidth=1, alpha=0.3)

    # 지역별 마커 그리기
    for idx, row in df.iterrows():
        region = row['region']
        vuln = row['vulnerability']
        risk = row['risk_level']

        # 시도 추출
        province = region.split()[0]
        if province in PROVINCE_INFO:
            info = PROVINCE_INFO[province]

            # 같은 시도 내 구/시 분산
            offset_lat = np.random.uniform(-0.15, 0.15)
            offset_lon = np.random.uniform(-0.15, 0.15)
            lat = info['lat'] + offset_lat
            lon = info['lon'] + offset_lon

            # 색상 및 크기
            color = cmap(norm(vuln))
            size = 400 + vuln * 600

            # 위험도에 따른 마커 스타일
            if risk == 'High':
                marker = 's'  # 사각형
                edgecolor = '#d73027'
                linewidth = 3
            elif risk == 'Medium':
                marker = 'o'  # 원형
                edgecolor = '#fc8d59'
                linewidth = 2
            else:
                marker = 'o'
                edgecolor = 'white'
                linewidth = 1.5

            # 마커 그리기
            ax_main.scatter(lon, lat, s=size, c=[color], marker=marker,
                           edgecolors=edgecolor, linewidths=linewidth, alpha=0.85, zorder=5)

            # 라벨 (High/Medium만)
            if risk in ['High', 'Medium']:
                short_name = region.split()[-1][:3]
                ax_main.annotate(f'{short_name}\n{vuln:.2f}', (lon, lat),
                               fontsize=7, ha='center', va='center',
                               fontweight='bold', color='white' if vuln > 0.45 else 'black')

    # 축 설정
    ax_main.set_xlim(124.5, 131)
    ax_main.set_ylim(33, 39)
    ax_main.set_xlabel('Longitude (°E)', fontsize=12, fontweight='bold')
    ax_main.set_ylabel('Latitude (°N)', fontsize=12, fontweight='bold')
    ax_main.set_title('Figure 3: Compound Climate Event Vulnerability Index by Region\n(2000-2023, 30 Districts Analyzed)',
                     fontsize=14, fontweight='bold', pad=15)
    ax_main.grid(True, alpha=0.3, linestyle='--')

    # 위도/경도 표시
    ax_main.set_xticks([125, 126, 127, 128, 129, 130])
    ax_main.set_yticks([33, 34, 35, 36, 37, 38, 39])

    # 컬러바 (오른쪽)
    ax_cbar = fig.add_axes([0.72, 0.35, 0.02, 0.45])
    sm = ScalarMappable(cmap=cmap, norm=norm)
    sm.set_array([])
    cbar = plt.colorbar(sm, cax=ax_cbar)
    cbar.set_label('Vulnerability Index', fontsize=12, fontweight='bold')
    cbar.set_ticks([0.2, 0.3, 0.4, 0.5, 0.6, 0.7])
    cbar.ax.set_yticklabels(['0.2\n(Very Low)', '0.3\n(Low)', '0.4', '0.5\n(Medium)', '0.6', '0.7\n(High)'])

    # 범례 (오른쪽 상단)
    ax_legend = fig.add_axes([0.76, 0.65, 0.22, 0.25])
    ax_legend.axis('off')
    ax_legend.set_title('Risk Level Legend', fontsize=11, fontweight='bold', loc='left')

    # 범례 아이템
    legend_items = [
        (mpatches.FancyBboxPatch((0.1, 0.7), 0.15, 0.15, boxstyle="square,pad=0.02",
                                  facecolor='#d73027', edgecolor='#d73027', linewidth=3),
         'High Risk (2 regions)\n- Seoul Gangnam\n- Daegu Suseong'),
        (plt.Circle((0.175, 0.45), 0.08, facecolor='#fc8d59', edgecolor='#fc8d59', linewidth=2),
         'Medium Risk (6 regions)\n- Busan Haeundae\n- Incheon Namdong, etc.'),
        (plt.Circle((0.175, 0.15), 0.07, facecolor='#91cf60', edgecolor='white', linewidth=1.5),
         'Low Risk (22 regions)')
    ]

    ax_legend.add_patch(mpatches.FancyBboxPatch((0.05, 0.65), 0.12, 0.12, boxstyle="square,pad=0.02",
                                                 facecolor='#d73027', edgecolor='#d73027', linewidth=3))
    ax_legend.text(0.22, 0.71, 'High Risk (2 regions)\n  - Seoul Gangnam-gu\n  - Daegu Suseong-gu',
                  fontsize=9, va='center', fontfamily='Malgun Gothic')

    circle1 = plt.Circle((0.11, 0.45), 0.06, facecolor='#fc8d59', edgecolor='#fc8d59', linewidth=2)
    ax_legend.add_patch(circle1)
    ax_legend.text(0.22, 0.45, 'Medium Risk (6 regions)\n  - Busan, Incheon, etc.',
                  fontsize=9, va='center', fontfamily='Malgun Gothic')

    circle2 = plt.Circle((0.11, 0.2), 0.05, facecolor='#91cf60', edgecolor='white', linewidth=1.5)
    ax_legend.add_patch(circle2)
    ax_legend.text(0.22, 0.2, 'Low Risk (22 regions)', fontsize=9, va='center')

    ax_legend.set_xlim(0, 1)
    ax_legend.set_ylim(0, 1)

    # 하단: 구성요소별 분석 바 차트
    ax_bar = fig.add_axes([0.08, 0.05, 0.85, 0.15])

    # High/Medium 위험 지역만 선택
    high_medium = df[df['risk_level'].isin(['High', 'Medium'])].sort_values('vulnerability', ascending=False)

    x = np.arange(len(high_medium))
    width = 0.25

    bars1 = ax_bar.bar(x - width, high_medium['exposure'], width, label='Exposure', color='#3498db', alpha=0.8)
    bars2 = ax_bar.bar(x, high_medium['sensitivity'], width, label='Sensitivity', color='#e74c3c', alpha=0.8)
    bars3 = ax_bar.bar(x + width, high_medium['adaptive_capacity'], width, label='Adaptive Capacity', color='#2ecc71', alpha=0.8)

    ax_bar.set_ylabel('Score', fontsize=10, fontweight='bold')
    ax_bar.set_xlabel('High/Medium Risk Regions', fontsize=10, fontweight='bold')
    ax_bar.set_title('Vulnerability Components for High/Medium Risk Regions', fontsize=11, fontweight='bold')
    ax_bar.set_xticks(x)
    ax_bar.set_xticklabels([r.split()[-1][:4] for r in high_medium['region']], rotation=45, ha='right', fontsize=8)
    ax_bar.legend(loc='upper right', fontsize=9)
    ax_bar.set_ylim(0, 0.8)
    ax_bar.grid(True, alpha=0.3, axis='y')

    # 저장
    plt.savefig(output_path, dpi=300, bbox_inches='tight', facecolor='white')
    print(f"Saved: {output_path}")
    plt.close()

    return output_path


def create_comprehensive_analysis_figure(df, output_path):
    """종합 분석 Figure 생성"""

    fig, axes = plt.subplots(2, 3, figsize=(18, 12))

    # 1. 취약성 분포 히스토그램
    ax1 = axes[0, 0]
    colors = ['#d73027' if r == 'High' else '#fc8d59' if r == 'Medium' else '#91cf60'
              for r in df['risk_level']]
    bars = ax1.bar(range(len(df)), df['vulnerability'].sort_values(ascending=False).values,
                   color=[colors[i] for i in df['vulnerability'].sort_values(ascending=False).index])
    ax1.axhline(y=0.5, color='red', linestyle='--', linewidth=2, label='High Risk Threshold')
    ax1.axhline(y=0.4, color='orange', linestyle='--', linewidth=2, label='Medium Risk Threshold')
    ax1.set_xlabel('Region (ranked)', fontsize=11)
    ax1.set_ylabel('Vulnerability Index', fontsize=11)
    ax1.set_title('(a) Vulnerability Distribution\nacross 30 Regions', fontsize=12, fontweight='bold')
    ax1.legend(fontsize=9)
    ax1.grid(True, alpha=0.3, axis='y')

    # 2. 구성요소 상관관계
    ax2 = axes[0, 1]
    scatter = ax2.scatter(df['exposure'], df['sensitivity'],
                          c=df['vulnerability'], cmap='YlOrRd', s=100, alpha=0.7,
                          edgecolors='black', linewidths=0.5)
    ax2.set_xlabel('Exposure', fontsize=11)
    ax2.set_ylabel('Sensitivity', fontsize=11)
    ax2.set_title('(b) Exposure vs Sensitivity\n(color = vulnerability)', fontsize=12, fontweight='bold')
    plt.colorbar(scatter, ax=ax2, label='Vulnerability')
    ax2.grid(True, alpha=0.3)

    # 3. 적응역량 vs 취약성
    ax3 = axes[0, 2]
    risk_colors = {'High': '#d73027', 'Medium': '#fc8d59', 'Low': '#91cf60'}
    for risk in ['High', 'Medium', 'Low']:
        subset = df[df['risk_level'] == risk]
        ax3.scatter(subset['adaptive_capacity'], subset['vulnerability'],
                   c=risk_colors[risk], label=risk, s=100, alpha=0.7,
                   edgecolors='black', linewidths=0.5)
    ax3.set_xlabel('Adaptive Capacity', fontsize=11)
    ax3.set_ylabel('Vulnerability Index', fontsize=11)
    ax3.set_title('(c) Adaptive Capacity vs Vulnerability\nby Risk Level', fontsize=12, fontweight='bold')
    ax3.legend(title='Risk Level', fontsize=9)
    ax3.grid(True, alpha=0.3)

    # 추세선
    z = np.polyfit(df['adaptive_capacity'], df['vulnerability'], 1)
    p = np.poly1d(z)
    x_line = np.linspace(df['adaptive_capacity'].min(), df['adaptive_capacity'].max(), 100)
    ax3.plot(x_line, p(x_line), 'k--', linewidth=2, label=f'Trend (r={np.corrcoef(df["adaptive_capacity"], df["vulnerability"])[0,1]:.2f})')
    ax3.legend(title='Risk Level', fontsize=9)

    # 4. 지역별 구성요소 레이더 차트 (High Risk)
    ax4 = axes[1, 0]
    high_risk = df[df['risk_level'] == 'High']

    categories = ['Exposure', 'Sensitivity', 'Vulnerability']
    N = len(categories)
    angles = [n / float(N) * 2 * np.pi for n in range(N)]
    angles += angles[:1]

    ax4 = fig.add_subplot(2, 3, 4, polar=True)

    colors_radar = ['#d73027', '#e74c3c']
    for i, (idx, row) in enumerate(high_risk.iterrows()):
        values = [row['exposure'], row['sensitivity'], row['vulnerability']]
        values += values[:1]
        ax4.plot(angles, values, 'o-', linewidth=2, label=row['region'], color=colors_radar[i])
        ax4.fill(angles, values, alpha=0.25, color=colors_radar[i])

    ax4.set_xticks(angles[:-1])
    ax4.set_xticklabels(categories, fontsize=10)
    ax4.set_title('(d) High Risk Regions Profile', fontsize=12, fontweight='bold', pad=20)
    ax4.legend(loc='upper right', bbox_to_anchor=(1.3, 1), fontsize=9)

    # 5. 위험 등급별 박스플롯
    ax5 = axes[1, 1]
    risk_order = ['Low', 'Medium', 'High']
    df_plot = df.copy()
    df_plot['risk_level'] = pd.Categorical(df_plot['risk_level'], categories=risk_order, ordered=True)

    bp = ax5.boxplot([df[df['risk_level'] == r]['vulnerability'].values for r in risk_order],
                     labels=risk_order, patch_artist=True)
    colors_box = ['#91cf60', '#fc8d59', '#d73027']
    for patch, color in zip(bp['boxes'], colors_box):
        patch.set_facecolor(color)
        patch.set_alpha(0.7)
    ax5.set_xlabel('Risk Level', fontsize=11)
    ax5.set_ylabel('Vulnerability Index', fontsize=11)
    ax5.set_title('(e) Vulnerability by Risk Level', fontsize=12, fontweight='bold')
    ax5.grid(True, alpha=0.3, axis='y')

    # 6. 시도별 평균 취약성
    ax6 = axes[1, 2]
    df['province'] = df['region'].apply(lambda x: x.split()[0])
    province_mean = df.groupby('province')['vulnerability'].mean().sort_values(ascending=True)

    cmap_prov = LinearSegmentedColormap.from_list('vuln',
        ['#1a9850', '#91cf60', '#d9ef8b', '#fee08b', '#fc8d59', '#d73027'])
    colors_prov = [cmap_prov((v - 0.2) / 0.5) for v in province_mean.values]

    bars = ax6.barh(range(len(province_mean)), province_mean.values, color=colors_prov, alpha=0.8)
    ax6.set_yticks(range(len(province_mean)))
    ax6.set_yticklabels(province_mean.index, fontsize=10)
    ax6.set_xlabel('Mean Vulnerability Index', fontsize=11)
    ax6.set_title('(f) Provincial Average Vulnerability', fontsize=12, fontweight='bold')
    ax6.axvline(x=0.4, color='orange', linestyle='--', linewidth=2)
    ax6.grid(True, alpha=0.3, axis='x')

    plt.tight_layout()
    plt.savefig(output_path, dpi=300, bbox_inches='tight', facecolor='white')
    print(f"Saved: {output_path}")
    plt.close()


def main():
    """메인 실행"""
    print("=" * 60)
    print("Generating Precise Vulnerability Maps...")
    print("=" * 60)

    # 데이터 로드
    df = load_vulnerability_data()
    print(f"Loaded {len(df)} regions")
    print(f"Risk Distribution: {df['risk_level'].value_counts().to_dict()}")

    # 출력 경로
    output_dir = Path("results/figures")
    output_dir.mkdir(parents=True, exist_ok=True)

    # 1. 정밀 취약성 지도 (Figure 3)
    map_path = output_dir / "fig1_vulnerability_map.png"
    create_detailed_vulnerability_map(df, str(map_path))

    # 2. 종합 분석 Figure
    analysis_path = output_dir / "fig4_comprehensive_analysis.png"
    create_comprehensive_analysis_figure(df, str(analysis_path))

    print("\n" + "=" * 60)
    print("All figures generated successfully!")
    print("=" * 60)


if __name__ == "__main__":
    main()
