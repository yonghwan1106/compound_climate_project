"""
한국 취약성 지도 - 정밀 버전
실제 한국 지도 배경 + 명확한 지명 라벨
"""

import matplotlib.pyplot as plt
import matplotlib.patches as mpatches
from matplotlib.colors import LinearSegmentedColormap
import numpy as np
import pandas as pd
from pathlib import Path
import matplotlib.font_manager as fm

# 한글 폰트 설정
plt.rcParams['font.family'] = 'Malgun Gothic'
plt.rcParams['axes.unicode_minus'] = False

def create_korea_outline():
    """한반도 윤곽선 좌표 (상세 버전)"""
    # 남한 주요 해안선 좌표 (더 상세한 버전)
    korea_outline = np.array([
        # 서해안 (서쪽)
        [126.1, 37.0], [126.3, 36.8], [126.4, 36.6], [126.5, 36.4],
        [126.4, 36.2], [126.5, 36.0], [126.6, 35.8], [126.5, 35.6],
        [126.4, 35.4], [126.5, 35.2], [126.7, 35.0], [126.8, 34.8],
        [126.9, 34.6], [127.0, 34.4], [127.2, 34.3], [127.4, 34.4],
        # 남해안
        [127.6, 34.5], [127.8, 34.6], [128.0, 34.7], [128.2, 34.8],
        [128.4, 34.9], [128.6, 35.0], [128.8, 35.1], [129.0, 35.1],
        # 동해안 (동쪽)
        [129.1, 35.2], [129.2, 35.4], [129.3, 35.6], [129.4, 35.8],
        [129.4, 36.0], [129.5, 36.2], [129.5, 36.4], [129.5, 36.6],
        [129.4, 36.8], [129.3, 37.0], [129.2, 37.2], [129.1, 37.4],
        [129.0, 37.6], [128.9, 37.8], [128.8, 38.0], [128.6, 38.2],
        [128.4, 38.4], [128.2, 38.5],
        # 북쪽 경계 (DMZ 근처)
        [128.0, 38.4], [127.8, 38.3], [127.6, 38.2], [127.4, 38.1],
        [127.2, 38.0], [127.0, 37.9], [126.8, 37.8], [126.6, 37.7],
        [126.4, 37.6], [126.2, 37.5], [126.1, 37.4], [126.0, 37.2],
        [126.1, 37.0]  # 시작점으로 돌아옴
    ])
    return korea_outline

def create_province_boundaries():
    """시도별 대략적인 경계 (간략화)"""
    provinces = {
        '서울': {'center': (127.0, 37.55), 'bounds': [(126.75, 37.4), (127.2, 37.7)]},
        '경기': {'center': (127.1, 37.3), 'bounds': [(126.4, 36.9), (127.8, 38.0)]},
        '인천': {'center': (126.65, 37.45), 'bounds': [(126.3, 37.3), (126.8, 37.6)]},
        '강원': {'center': (128.2, 37.5), 'bounds': [(127.5, 37.0), (129.0, 38.5)]},
        '충북': {'center': (127.7, 36.8), 'bounds': [(127.2, 36.4), (128.2, 37.2)]},
        '충남': {'center': (126.9, 36.5), 'bounds': [(126.3, 36.0), (127.5, 37.0)]},
        '대전': {'center': (127.4, 36.35), 'bounds': [(127.2, 36.2), (127.5, 36.5)]},
        '세종': {'center': (127.25, 36.55), 'bounds': [(127.1, 36.4), (127.4, 36.7)]},
        '전북': {'center': (127.1, 35.8), 'bounds': [(126.4, 35.4), (127.6, 36.2)]},
        '전남': {'center': (126.9, 34.9), 'bounds': [(126.2, 34.3), (127.6, 35.5)]},
        '광주': {'center': (126.85, 35.15), 'bounds': [(126.7, 35.0), (127.0, 35.3)]},
        '경북': {'center': (128.6, 36.2), 'bounds': [(127.8, 35.5), (129.5, 37.0)]},
        '경남': {'center': (128.2, 35.3), 'bounds': [(127.6, 34.8), (129.0, 35.8)]},
        '대구': {'center': (128.6, 35.85), 'bounds': [(128.4, 35.7), (128.8, 36.0)]},
        '울산': {'center': (129.3, 35.55), 'bounds': [(129.1, 35.4), (129.5, 35.7)]},
        '부산': {'center': (129.05, 35.15), 'bounds': [(128.9, 35.0), (129.2, 35.3)]},
        '제주': {'center': (126.55, 33.4), 'bounds': [(126.1, 33.2), (127.0, 33.6)]},
    }
    return provinces

def get_region_data():
    """30개 지역 데이터 (좌표 + 취약성)"""
    regions = [
        # 서울
        {'name': '서울 강남구', 'lat': 37.52, 'lon': 127.05, 'vuln': 0.603, 'risk': 'High'},
        {'name': '서울 서초구', 'lat': 37.48, 'lon': 127.03, 'vuln': 0.478, 'risk': 'Medium'},
        {'name': '서울 송파구', 'lat': 37.51, 'lon': 127.11, 'vuln': 0.385, 'risk': 'Low'},
        {'name': '서울 강서구', 'lat': 37.55, 'lon': 126.85, 'vuln': 0.342, 'risk': 'Low'},
        {'name': '서울 노원구', 'lat': 37.65, 'lon': 127.06, 'vuln': 0.328, 'risk': 'Low'},
        # 경기
        {'name': '경기 수원시', 'lat': 37.27, 'lon': 127.02, 'vuln': 0.445, 'risk': 'Medium'},
        {'name': '경기 성남시', 'lat': 37.42, 'lon': 127.13, 'vuln': 0.412, 'risk': 'Medium'},
        {'name': '경기 고양시', 'lat': 37.66, 'lon': 126.83, 'vuln': 0.356, 'risk': 'Low'},
        {'name': '경기 용인시', 'lat': 37.24, 'lon': 127.18, 'vuln': 0.334, 'risk': 'Low'},
        {'name': '경기 파주시', 'lat': 37.76, 'lon': 126.78, 'vuln': 0.298, 'risk': 'Low'},
        # 인천
        {'name': '인천 강화군', 'lat': 37.75, 'lon': 126.49, 'vuln': 0.456, 'risk': 'Medium'},
        {'name': '인천 연수구', 'lat': 37.41, 'lon': 126.68, 'vuln': 0.367, 'risk': 'Low'},
        # 부산
        {'name': '부산 해운대구', 'lat': 35.16, 'lon': 129.16, 'vuln': 0.489, 'risk': 'Medium'},
        {'name': '부산 사하구', 'lat': 35.10, 'lon': 128.97, 'vuln': 0.378, 'risk': 'Low'},
        # 대구
        {'name': '대구 수성구', 'lat': 35.86, 'lon': 128.63, 'vuln': 0.636, 'risk': 'High'},
        {'name': '대구 달서구', 'lat': 35.83, 'lon': 128.53, 'vuln': 0.389, 'risk': 'Low'},
        # 광주
        {'name': '광주 북구', 'lat': 35.17, 'lon': 126.91, 'vuln': 0.423, 'risk': 'Medium'},
        {'name': '광주 서구', 'lat': 35.15, 'lon': 126.88, 'vuln': 0.356, 'risk': 'Low'},
        # 대전
        {'name': '대전 유성구', 'lat': 36.36, 'lon': 127.36, 'vuln': 0.401, 'risk': 'Medium'},
        {'name': '대전 서구', 'lat': 36.35, 'lon': 127.38, 'vuln': 0.345, 'risk': 'Low'},
        # 울산
        {'name': '울산 중구', 'lat': 35.57, 'lon': 129.33, 'vuln': 0.412, 'risk': 'Medium'},
        {'name': '울산 북구', 'lat': 35.58, 'lon': 129.36, 'vuln': 0.356, 'risk': 'Low'},
        # 강원
        {'name': '강원 춘천시', 'lat': 37.88, 'lon': 127.73, 'vuln': 0.312, 'risk': 'Low'},
        {'name': '강원 원주시', 'lat': 37.34, 'lon': 127.95, 'vuln': 0.298, 'risk': 'Low'},
        # 충청
        {'name': '충북 청주시', 'lat': 36.64, 'lon': 127.49, 'vuln': 0.334, 'risk': 'Low'},
        {'name': '충남 천안시', 'lat': 36.81, 'lon': 127.15, 'vuln': 0.312, 'risk': 'Low'},
        # 전라
        {'name': '전북 전주시', 'lat': 35.82, 'lon': 127.15, 'vuln': 0.356, 'risk': 'Low'},
        {'name': '전남 목포시', 'lat': 34.81, 'lon': 126.39, 'vuln': 0.378, 'risk': 'Low'},
        # 경상
        {'name': '경북 포항시', 'lat': 36.02, 'lon': 129.37, 'vuln': 0.345, 'risk': 'Low'},
        {'name': '경남 창원시', 'lat': 35.23, 'lon': 128.68, 'vuln': 0.367, 'risk': 'Low'},
    ]
    return pd.DataFrame(regions)


def draw_korea_map(ax):
    """한국 지도 배경 그리기"""
    # 바다 배경
    ax.set_facecolor('#e6f3ff')

    # 한반도 윤곽
    korea = create_korea_outline()
    korea_patch = plt.Polygon(korea, facecolor='#f5f5dc', edgecolor='#333333',
                               linewidth=2, alpha=0.9, zorder=1)
    ax.add_patch(korea_patch)

    # 제주도
    jeju = np.array([
        [126.15, 33.25], [126.25, 33.20], [126.45, 33.22], [126.65, 33.25],
        [126.85, 33.30], [126.95, 33.40], [126.90, 33.50], [126.70, 33.55],
        [126.45, 33.52], [126.25, 33.45], [126.15, 33.35], [126.15, 33.25]
    ])
    jeju_patch = plt.Polygon(jeju, facecolor='#f5f5dc', edgecolor='#333333',
                              linewidth=2, alpha=0.9, zorder=1)
    ax.add_patch(jeju_patch)

    # 주요 도시 표시 (연한 선)
    provinces = create_province_boundaries()
    for prov, info in provinces.items():
        # 도 이름 라벨 (연하게)
        if prov in ['서울', '인천', '대전', '광주', '대구', '울산', '부산', '세종']:
            continue  # 광역시는 건너뛰기 (지역 마커로 표시)
        ax.text(info['center'][0], info['center'][1], prov,
                fontsize=9, alpha=0.3, ha='center', va='center',
                fontweight='normal', color='#666666', zorder=0)


def create_vulnerability_map_v2(df, output_path):
    """개선된 취약성 지도 생성"""

    fig, ax = plt.subplots(1, 1, figsize=(16, 18))

    # 한국 지도 그리기
    draw_korea_map(ax)

    # 컬러맵
    cmap = LinearSegmentedColormap.from_list('vuln',
        ['#1a9850', '#66bd63', '#a6d96a', '#d9ef8b', '#fee08b', '#fdae61', '#f46d43', '#d73027'])

    # 취약성 값 정규화
    norm = plt.Normalize(vmin=0.25, vmax=0.70)

    # 위험 등급별로 그리기
    risk_styles = {
        'High': {'marker': 's', 'size': 450, 'edgecolor': '#b91c1c', 'linewidth': 4},
        'Medium': {'marker': 'o', 'size': 350, 'edgecolor': '#d97706', 'linewidth': 3},
        'Low': {'marker': 'o', 'size': 250, 'edgecolor': '#059669', 'linewidth': 2}
    }

    # 지역 마커 그리기
    for idx, row in df.iterrows():
        style = risk_styles[row['risk']]
        color = cmap(norm(row['vuln']))

        # 마커 그리기
        ax.scatter(row['lon'], row['lat'],
                  c=[color], s=style['size'], marker=style['marker'],
                  edgecolors=style['edgecolor'], linewidths=style['linewidth'],
                  alpha=0.85, zorder=5)

    # 지역명 라벨 추가 (모든 지역)
    for idx, row in df.iterrows():
        # 라벨 위치 조정 (겹침 방지)
        label_offset_x = 0.12
        label_offset_y = 0.08

        # 특정 지역 위치 미세 조정
        name_short = row['name'].split()[-1]  # 마지막 단어 (구/시/군)

        # 위치에 따른 라벨 방향 조정
        if row['lon'] > 128.5:  # 동쪽 지역
            ha = 'left'
            offset_x = label_offset_x
        elif row['lon'] < 127.0:  # 서쪽 지역
            ha = 'right'
            offset_x = -label_offset_x
        else:
            ha = 'center'
            offset_x = 0

        # High Risk는 전체 이름, 나머지는 짧은 이름
        if row['risk'] == 'High':
            display_name = row['name']
            fontsize = 11
            fontweight = 'bold'
            bbox_props = dict(boxstyle='round,pad=0.3', facecolor='#fee2e2',
                            edgecolor='#dc2626', alpha=0.95)
        elif row['risk'] == 'Medium':
            display_name = row['name']
            fontsize = 9
            fontweight = 'bold'
            bbox_props = dict(boxstyle='round,pad=0.2', facecolor='#fef3c7',
                            edgecolor='#d97706', alpha=0.9)
        else:
            display_name = name_short
            fontsize = 8
            fontweight = 'normal'
            bbox_props = dict(boxstyle='round,pad=0.15', facecolor='white',
                            edgecolor='#9ca3af', alpha=0.85)

        ax.annotate(display_name,
                   xy=(row['lon'], row['lat']),
                   xytext=(row['lon'] + offset_x, row['lat'] + label_offset_y),
                   fontsize=fontsize, fontweight=fontweight,
                   ha=ha, va='bottom',
                   bbox=bbox_props,
                   zorder=10,
                   arrowprops=dict(arrowstyle='-', color='#666666', lw=0.5) if row['risk'] in ['High', 'Medium'] else None)

    # 제목
    ax.set_title('Figure 3: 복합 극한기후 취약성 지수 (2000-2023)\n'
                'Compound Climate Event Vulnerability Index by Region',
                fontsize=18, fontweight='bold', pad=20)

    # 축 설정
    ax.set_xlim(125.5, 130.0)
    ax.set_ylim(33.0, 38.8)
    ax.set_xlabel('경도 (Longitude, °E)', fontsize=12)
    ax.set_ylabel('위도 (Latitude, °N)', fontsize=12)
    ax.set_aspect('equal')
    ax.grid(True, alpha=0.3, linestyle='--')

    # 컬러바
    sm = plt.cm.ScalarMappable(cmap=cmap, norm=norm)
    sm.set_array([])
    cbar = plt.colorbar(sm, ax=ax, shrink=0.6, aspect=30, pad=0.02)
    cbar.set_label('취약성 지수 (Vulnerability Index)', fontsize=12)
    cbar.ax.tick_params(labelsize=10)

    # 범례 만들기
    legend_elements = [
        plt.scatter([], [], c='#d73027', s=400, marker='s', edgecolors='#b91c1c',
                   linewidths=3, label='High Risk (V ≥ 0.55)\n  - 서울 강남구\n  - 대구 수성구'),
        plt.scatter([], [], c='#fdae61', s=300, marker='o', edgecolors='#d97706',
                   linewidths=2, label='Medium Risk (0.40-0.55)\n  6 regions'),
        plt.scatter([], [], c='#66bd63', s=200, marker='o', edgecolors='#059669',
                   linewidths=1.5, label='Low Risk (V < 0.40)\n  22 regions'),
    ]

    leg = ax.legend(handles=legend_elements, loc='upper right', fontsize=10,
                   title='위험 등급 (Risk Level)', title_fontsize=11,
                   framealpha=0.95, edgecolor='#333333')
    leg.get_frame().set_facecolor('white')

    # 통계 정보 박스
    stats_text = (
        '■ 분석 개요\n'
        f'  • 분석 지역: 30개 시군구\n'
        f'  • 분석 기간: 2000-2023 (24년)\n'
        f'  • 취약성 범위: 0.298 ~ 0.636\n'
        f'  • 평균 취약성: {df["vuln"].mean():.3f}\n\n'
        '■ 위험 등급 분포\n'
        f'  • High (고위험): 2개 지역 (6.7%)\n'
        f'  • Medium (중위험): 6개 지역 (20.0%)\n'
        f'  • Low (저위험): 22개 지역 (73.3%)'
    )

    ax.text(0.02, 0.02, stats_text, transform=ax.transAxes,
           fontsize=10, verticalalignment='bottom',
           bbox=dict(boxstyle='round', facecolor='#f0f9ff', edgecolor='#0284c7', alpha=0.95),
           family='Malgun Gothic')

    plt.tight_layout()
    plt.savefig(output_path, dpi=300, bbox_inches='tight', facecolor='white')
    print(f"Saved: {output_path}")
    plt.close()


def create_detailed_regional_analysis(df, output_path):
    """상세 지역 분석 차트"""

    fig = plt.figure(figsize=(18, 12))

    # 1. 취약성 순위 바 차트 (왼쪽 상단)
    ax1 = fig.add_subplot(2, 2, 1)
    df_sorted = df.sort_values('vuln', ascending=True)

    colors = []
    for risk in df_sorted['risk']:
        if risk == 'High':
            colors.append('#dc2626')
        elif risk == 'Medium':
            colors.append('#d97706')
        else:
            colors.append('#059669')

    bars = ax1.barh(range(len(df_sorted)), df_sorted['vuln'], color=colors, alpha=0.8, edgecolor='white')
    ax1.set_yticks(range(len(df_sorted)))
    ax1.set_yticklabels(df_sorted['name'], fontsize=8)
    ax1.set_xlabel('취약성 지수 (Vulnerability Index)', fontsize=11)
    ax1.set_title('(a) 지역별 취약성 순위\nRegional Vulnerability Ranking', fontsize=12, fontweight='bold')
    ax1.axvline(x=0.40, color='#d97706', linestyle='--', linewidth=2, label='Medium threshold')
    ax1.axvline(x=0.55, color='#dc2626', linestyle='--', linewidth=2, label='High threshold')
    ax1.legend(fontsize=9)
    ax1.grid(True, alpha=0.3, axis='x')

    # 2. 위험 등급 분포 파이 차트 (오른쪽 상단)
    ax2 = fig.add_subplot(2, 2, 2)
    risk_counts = df['risk'].value_counts()
    risk_order = ['Low', 'Medium', 'High']
    counts = [risk_counts.get(r, 0) for r in risk_order]
    colors_pie = ['#10b981', '#f59e0b', '#ef4444']
    explode = (0, 0.05, 0.1)

    wedges, texts, autotexts = ax2.pie(counts, explode=explode, labels=risk_order,
                                        colors=colors_pie, autopct='%1.1f%%',
                                        shadow=True, startangle=90,
                                        textprops={'fontsize': 11})
    autotexts[2].set_fontweight('bold')
    ax2.set_title('(b) 위험 등급 분포\nRisk Level Distribution', fontsize=12, fontweight='bold')

    # 3. 고위험/중위험 지역 상세 분석 (왼쪽 하단)
    ax3 = fig.add_subplot(2, 2, 3)
    high_medium = df[df['risk'].isin(['High', 'Medium'])].copy()
    high_medium = high_medium.sort_values('vuln', ascending=False)

    x = np.arange(len(high_medium))
    width = 0.6

    bars = ax3.bar(x, high_medium['vuln'], width,
                   color=['#dc2626' if r == 'High' else '#f59e0b' for r in high_medium['risk']],
                   edgecolor='white', linewidth=2)

    ax3.set_xticks(x)
    ax3.set_xticklabels(high_medium['name'], rotation=45, ha='right', fontsize=9)
    ax3.set_ylabel('취약성 지수', fontsize=11)
    ax3.set_title('(c) 고위험/중위험 지역 취약성\nHigh & Medium Risk Regions', fontsize=12, fontweight='bold')
    ax3.axhline(y=0.55, color='#dc2626', linestyle='--', linewidth=2, alpha=0.7)
    ax3.axhline(y=0.40, color='#d97706', linestyle='--', linewidth=2, alpha=0.7)

    # 값 라벨
    for bar, val in zip(bars, high_medium['vuln']):
        ax3.text(bar.get_x() + bar.get_width()/2, bar.get_height() + 0.01,
                f'{val:.3f}', ha='center', va='bottom', fontsize=9, fontweight='bold')

    ax3.grid(True, alpha=0.3, axis='y')
    ax3.set_ylim(0, 0.75)

    # 4. 시도별 평균 취약성 (오른쪽 하단)
    ax4 = fig.add_subplot(2, 2, 4)
    df['province'] = df['name'].apply(lambda x: x.split()[0])
    province_mean = df.groupby('province')['vuln'].mean().sort_values(ascending=True)

    cmap = LinearSegmentedColormap.from_list('vuln',
        ['#10b981', '#84cc16', '#eab308', '#f97316', '#ef4444'])
    norm = plt.Normalize(vmin=province_mean.min(), vmax=province_mean.max())
    colors_prov = [cmap(norm(v)) for v in province_mean.values]

    bars = ax4.barh(range(len(province_mean)), province_mean.values,
                    color=colors_prov, edgecolor='white', linewidth=1.5)
    ax4.set_yticks(range(len(province_mean)))
    ax4.set_yticklabels(province_mean.index, fontsize=10)
    ax4.set_xlabel('평균 취약성 지수', fontsize=11)
    ax4.set_title('(d) 시도별 평균 취약성\nProvincial Average Vulnerability', fontsize=12, fontweight='bold')
    ax4.axvline(x=0.40, color='#d97706', linestyle='--', linewidth=2, alpha=0.7)
    ax4.grid(True, alpha=0.3, axis='x')

    # 값 라벨
    for bar, val in zip(bars, province_mean.values):
        ax4.text(val + 0.005, bar.get_y() + bar.get_height()/2,
                f'{val:.3f}', ha='left', va='center', fontsize=9)

    plt.tight_layout()
    plt.savefig(output_path, dpi=300, bbox_inches='tight', facecolor='white')
    print(f"Saved: {output_path}")
    plt.close()


def main():
    print("=" * 60)
    print("한국 취약성 지도 생성 (개선 버전)")
    print("=" * 60)

    # 출력 디렉토리
    output_dir = Path("results/figures")
    output_dir.mkdir(parents=True, exist_ok=True)

    # 데이터 로드
    df = get_region_data()
    print(f"Loaded {len(df)} regions")
    print(f"Risk Distribution: {df['risk'].value_counts().to_dict()}")

    # 1. 메인 취약성 지도
    map_path = output_dir / "fig3_vulnerability_map_v2.png"
    create_vulnerability_map_v2(df, str(map_path))

    # 2. 상세 분석 차트
    analysis_path = output_dir / "fig3_regional_analysis.png"
    create_detailed_regional_analysis(df, str(analysis_path))

    print("\n" + "=" * 60)
    print("완료! 생성된 파일:")
    print(f"  1. {map_path}")
    print(f"  2. {analysis_path}")
    print("=" * 60)


if __name__ == "__main__":
    main()
